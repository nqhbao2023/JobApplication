name: Auto Crawler - Viecoi.vn Jobs

on:
  # ⚠️ DISABLED: viecoi.vn blocks GitHub Actions IPs (403 Forbidden)
  # Chạy crawler thủ công từ máy local thay vì dùng GitHub Actions
  # schedule:
  #   - cron: '0 */6 * * *'
  
  # Vẫn cho phép trigger thủ công để test
  workflow_dispatch:

jobs:
  crawl-jobs:
    name: Crawl Jobs from Viecoi.vn
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      - name: Install dependencies
        run: |
          cd server
          npm ci
      
      - name: Verify Firebase credentials
        run: |
          if [ -z "$FIREBASE_SERVICE_ACCOUNT" ] && [ -z "$FIREBASE_PROJECT_ID" ]; then
            echo "❌ Error: Missing Firebase credentials!"
            echo "Please add FIREBASE_SERVICE_ACCOUNT or (FIREBASE_PROJECT_ID + FIREBASE_CLIENT_EMAIL + FIREBASE_PRIVATE_KEY) to GitHub Secrets"
            exit 1
          fi
          echo "✅ Firebase credentials found"
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      
      - name: Run crawler (fetch + normalize only)
        run: |
          cd server
          npm run crawl:viecoi-jobs
          npm run normalize:viecoi
        env:
          # No Firebase needed for crawling stage
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_API_URL: ${{ secrets.AI_API_URL }}
      
      - name: Upsert jobs to Firestore
        run: |
          cd server
          npm run upsert:viecoi-jobs
        env:
          # Firebase credentials (stored in GitHub Secrets)
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          
          # Algolia credentials (stored in GitHub Secrets)
          ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
          ALGOLIA_INDEX_NAME: ${{ secrets.ALGOLIA_INDEX_NAME }}
      
      - name: Sync to Algolia
        if: success()
        run: |
          cd server
          npm run sync:viecoi-algolia
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
          ALGOLIA_INDEX_NAME: ${{ secrets.ALGOLIA_INDEX_NAME }}
      
      - name: Notify on success
        if: success()
        run: |
          echo "✅ Crawler completed successfully at $(date)"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Crawler failed at $(date)"
          exit 1
